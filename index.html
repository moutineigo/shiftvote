<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ã‚·ãƒ•ãƒˆå…¥åŠ›</title>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  margin: 0;
  padding: 8px; 
  background: #f7f7f7;
}

header {
  position: sticky;
  top: 0;
  background: #fff;
  z-index: 10;
  border-bottom: 1px solid #ccc;
  /* padding: 10px; */
  padding: calc(10px + env(safe-area-inset-top)) 10px 10px;

}



h1 {
  margin: 0;
  font-size: 18px;
}

.deadline {
  font-size: 12px;
  color: #555;
}

/*
.table-wrap {
  overflow: auto;
  height: calc(100vh - var(--header-h, 52px));
  background: #fff;
}
*/

.table-wrap{
  overflow: auto;
  overscroll-behavior: contain;
  height: calc(100vh - var(--header-h, 52px) - 16px);

  padding-top: 0;
  padding-left: 0;
  padding-right: 8px;

  padding-bottom: calc(8px + env(safe-area-inset-bottom));
  background: #fff;
  border-radius: 10px;
}

table {
  border-collapse: separate;
  border-spacing: 0;
  width: max-content;
  background: #fff;
}

th, td {
  border: 1px solid #ccc;
  min-width: 56px;
  height: 48px;
  text-align: center;
  font-size: 18px;
  overflow: hidden;  
}

th {
  background: #f0f0f0;
  font-size: 12px;
}

th.sticky-left.sticky-top{
  z-index: 8;
}

th.sticky-top{
  position: sticky;
  top: 0; 
  z-index: 5;
  background: #f0f0f0;
}

th.sticky-left,
td.sticky-left {
  position: sticky;
  left: 0;
  background: #fff;
  z-index: 4;
}

th.sticky-left {
  background: #f0f0f0;
  z-index: 6;
}

td.cell {
  cursor: default;
}

td.cell.saving {
  opacity: 0.5;
}

.date-head {
  line-height: 1.2;
  font-size: 11px;
}

.cell-box {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  height: 100%;
}

.cell-btns {
  display: flex;
  gap: 4px;
}

.cell-btn {
  width: 22px;
  height: 22px;
  font-size: 13px;
  border-radius: 4px;
  border: 1px solid #e67e22;
  background: #ffe5d0;
  padding: 0;
  cursor: pointer;
}

.cell-cur {
  font-size: 18px;
  line-height: 1;
  margin-top: 4px;
}

th.lock-head {
  min-width: 92px;
  font-size: 12px;
}

td.lock-cell {
  min-width: 92px;
  background: #f9fbff;
}

.lock-btn {
  font-size: 12px;
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid #4aa3df;
  background: #cfefff;
  cursor: pointer;
}

.lock-btn.is-ok {
  background: #bfe6ff;
}

.lock-btn.is-ng {
  background: #d7f2ff;
  opacity: 0.95;
}

/* ãƒ­ãƒƒã‚¯ä¸­ï¼šãã®è¡Œã®å…¥åŠ›ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ– */
tr.is-locked td.cell .cell-btn {
  pointer-events: none;
  opacity: 0.35;
}

tr.is-locked td.cell .cell-cur {
  opacity: 0.8;
}

.lock-stack {
  display: flex;
  flex-direction: column;
  gap: 6px;
  padding: 6px 0;
}

.lock-btn.is-disabled {
  opacity: 0.35;
  pointer-events: none;
  filter: grayscale(100%);
}

td, th { position: relative; }

/* å·¦å›ºå®šï¼ˆæ‹…å½“è€…åˆ—ï¼‰ï¼šæœ¬æ–‡ã‚ˆã‚Šä¸Š */
td.sticky-left {
  z-index: 20;
}

/* ä¸Šå›ºå®šï¼ˆãƒ˜ãƒƒãƒ€è¡Œï¼‰ï¼šæœ¬æ–‡ã‚ˆã‚Šä¸Š */
th.sticky-top {
  z-index: 30;
}

/* å·¦ä¸Šï¼ˆæ‹…å½“è€…ãƒ˜ãƒƒãƒ€ï¼‰ï¼šæœ€å‰é¢ */
th.sticky-left.sticky-top {
  z-index: 40;
}

td.cell { padding: 0; }
.cell-box {
  width: 100%;
  height: 100%;
  overflow: hidden;
  box-sizing: border-box;
}

@supports (height: 100dvh) {
  .table-wrap{
    height: calc(100dvh - var(--header-h, 52px) - 16px);
  }
}

@media (max-width: 768px) {
  th.sticky-left,
  td.sticky-left {
    min-width: 90px;
    width: 90px;
    font-size: 15px;
    white-space: normal;
    word-break: break-all;
  }
}

/* ===== è¦‹ã‚„ã™ã•ç”¨ï¼šå¶æ•°è¡Œ/å¶æ•°åˆ—ã‚’è–„ãè‰²æ›¿ãˆ ===== */

/* ã¾ãš tbody ã®ã‚»ãƒ«èƒŒæ™¯ã‚’é€æ˜ã«ã™ã‚‹ï¼ˆè¡Œã®èƒŒæ™¯ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ï¼‰ */
#shiftTable tbody td { background: transparent; }

/* è¡Œã®ç¸ï¼ˆtr ã«èƒŒæ™¯ã‚’æŒãŸã›ã‚‹ï¼‰ */
#shiftTable tbody tr:nth-child(odd)  { background: #ffffff; }
#shiftTable tbody tr:nth-child(even) { background: #f3f3f3; }

/* åˆ—ã®ç¸ï¼ˆåŠé€æ˜ã§ä¸Šä¹—ã›ï¼šè¡Œã®ç¸ãŒæ¶ˆãˆãªã„ï¼‰ */
#shiftTable tbody td:nth-child(even) { background: rgba(230, 239, 255, 0.65); }

/* å¶æ•°è¡ŒÃ—å¶æ•°åˆ—ã¯å°‘ã—æ¿ƒã */
#shiftTable tbody tr:nth-child(even) td:nth-child(even) { background: rgba(230, 239, 255, 0.85); }

/* sticky-left / lock-cell ã‚‚ â€œè¡Œã®èƒŒæ™¯â€ ã‚’ç¶™æ‰¿ã•ã›ã‚‹ï¼ˆã“ã“ãŒé‡è¦ï¼‰ */
#shiftTable tbody td.sticky-left,
#shiftTable tbody td.lock-cell {
  background: inherit;
}

#shiftTable tbody tr:hover td { background: #fff3d9; }
#shiftTable tbody tr:hover td.sticky-left { background: #fff3d9; }

#shiftTable tbody tr:hover td:nth-child(even),
#shiftTable tbody tr:hover td:nth-child(even):nth-child(even) {
  background: #fff3d9 !important;
}

/* lockåˆ—ã¨æ‹…å½“è€…åˆ—ã‚‚ç¢ºå®Ÿã«æƒãˆã‚‹ */
#shiftTable tbody tr:hover td.sticky-left,
#shiftTable tbody tr:hover td.lock-cell {
  background: #fff3d9 !important;
}

#shiftTable tbody tr.is-hover-row td {
  background: #fff3d9 !important;
}

/* åˆ—ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
#shiftTable tbody td.is-hover-col {
  background: #fff3d9 !important;
}

/* stickyåˆ—ã‚‚å«ã‚ã‚‹ */
#shiftTable tbody tr.is-hover-row td.sticky-left,
#shiftTable tbody td.is-hover-col.sticky-left,
#shiftTable tbody td.is-hover-col.lock-cell {
  background: #fff3d9 !important;
}

/* ===== ã‚³ãƒ¡ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background: rgba(0,0,0,0.35);
  align-items:center;
  justify-content:center;
  z-index: 1000;
  padding: 16px;
}

.modal.show{ display:flex; }

.modal-box{
  width: min(520px, 100%);
  background:#fff;
  border-radius: 12px;
  padding: 12px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.25);
}

.modal-title{
  font-size: 14px;
  font-weight: 700;
  margin-bottom: 8px;
}

#commentText{
  width: 100%;
  height: 140px;
  resize: vertical;
  font-size: 14px;
  line-height: 1.4;
  padding: 10px;
  box-sizing: border-box;
}

.modal-actions{
  display:flex;
  gap: 8px;
  justify-content:flex-end;
  margin-top: 10px;
}

.modal-actions button{
  font-size: 14px;
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid #bbb;
  background: #f5f5f5;
  cursor: pointer;
}

th.comment-head { min-width: 64px; }
td.comment-cell { min-width: 64px; background: inherit; }

.comment-btn{
  width: 40px;
  height: 32px;
  border-radius: 8px;
  border: 1px solid #bbb;
  background: #fff;
  cursor: pointer;
}

/* é›†è¨ˆè¡Œï¼ˆãƒ˜ãƒƒãƒ€2æ®µç›®ï¼‰ */
th.summary-top{
  position: sticky;
  top: 48px;          /* 1æ®µç›®ãƒ˜ãƒƒãƒ€ã®é«˜ã•ã«åˆã‚ã›ã‚‹ï¼ˆå¾Œè¿°ã§JSã‹ã‚‰ä¸Šæ›¸ãæ¨å¥¨ï¼‰ */
  z-index: 29;
  background: #f0f0f0;
  font-size: 11px;
  line-height: 1.25;
  height: 40px;       /* å°‘ã—ä½ã‚ */
  vertical-align: middle;
}

.summary-box{
  display: grid;
  grid-template-columns: repeat(5, auto);
  gap: 6px 10px;
  justify-content: center;
  white-space: nowrap;
}

.summary-box span{
  font-variant-numeric: tabular-nums;
}

</style>
</head>

<body>

<header>
  <h1 id="title">Loading...</h1>
  <div class="deadline" id="deadline"></div>
</header>

<div class="table-wrap">
  <table id="shiftTable"></table>
</div>

<div id="commentModal" class="modal" aria-hidden="true">
  <div class="modal-box">
    <div class="modal-title">ã‚³ãƒ¡ãƒ³ãƒˆ</div>
    <textarea id="commentText" maxlength="1000" placeholder="æœ€å¤§1000æ–‡å­—"></textarea>
    <div class="modal-actions">
      <button id="commentSave" type="button">OK(ä¿å­˜)</button>
      <button id="commentCancel" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwWSNpt2pEiENW4q6wkzb51frdmyKCVLXhy9niMSeud8c81kjdLVTufookHHURW2nHp/exec";
const params = new URLSearchParams(location.search);
const month = params.get("month") || "2026-04";

let META = null;

function isRowComplete_(memberId) {
  // ãã®æ‹…å½“è€…ã®å…¨æ—¥ç¨‹ãŒã€Œãƒ¼ä»¥å¤–ã€ãªã‚‰OK
  return META.dates.every(d => {
    const v = RESP_MAP[`${memberId}|${d.date}`] || "ãƒ¼";
    return v !== "ãƒ¼" && v !== "";
  });
}


let RESP_MAP = {};
let COMMENT_MAP = {};
let lastTouched = {};

let CURRENT_COMMENT_MEMBER_ID = null;

function openCommentModal_(memberId) {
  CURRENT_COMMENT_MEMBER_ID = memberId;

  const modal = document.getElementById("commentModal");
  const ta = document.getElementById("commentText");
  ta.value = (COMMENT_MAP[memberId] || "");

  modal.classList.add("show");
  modal.setAttribute("aria-hidden", "false");

  // å°‘ã—å¾…ã£ã¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼ˆiOSå¯¾ç­–ï¼‰
  setTimeout(() => ta.focus(), 0);
}

function closeCommentModal_() {
  const modal = document.getElementById("commentModal");
  modal.classList.remove("show");
  modal.setAttribute("aria-hidden", "true");
  CURRENT_COMMENT_MEMBER_ID = null;
}

async function saveComment_() {
  if (!CURRENT_COMMENT_MEMBER_ID) return;

  const text = String(document.getElementById("commentText").value || "");

  // 1000æ–‡å­—åˆ¶é™ï¼ˆä¿é™ºï¼‰
  const clipped = text.length > 1000 ? text.slice(0, 1000) : text;

  const url =
    `${API_URL}?action=setcomment` +
    `&month_key=${encodeURIComponent(META.month_key)}` +
    `&member_id=${encodeURIComponent(CURRENT_COMMENT_MEMBER_ID)}` +
    `&comment=${encodeURIComponent(clipped)}`;

  const res = await fetchJSON(url);
  if (!res.ok) {
    alert("ã‚³ãƒ¡ãƒ³ãƒˆä¿å­˜å¤±æ•—: " + (res.error || ""));
    return;
  }

  // ãƒ­ãƒ¼ã‚«ãƒ«åæ˜  â†’ ğŸ“/ï¼‹ ã‚’å³æ›´æ–°
  COMMENT_MAP[CURRENT_COMMENT_MEMBER_ID] = clipped;
  closeCommentModal_();
  render();
  setupHoverHighlight_(); // renderå¾Œã«ãƒ›ãƒãƒ¼å†ãƒã‚¤ãƒ³ãƒ‰
}


function nextValue(cur, choices) {
  const i = choices.indexOf(cur);
  return choices[(i + 1) % choices.length];
}

async function fetchJSON(url) {
  const r = await fetch(url);
  return r.json();
}

async function postJSON(body) {
  return fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  }).then(r => r.json());
}

function buildRespMap(responses) {
  const map = {};
  responses.forEach(r => {
    map[`${r.member_id}|${r.date}`] = r.value;
  });
  return map;
}

function buildDaySummary_(dateStr) {
  const counts = { "ã€‡":0, "Ã—":0, "â–³":0, "ï¼Ÿ":0, "ãƒ¼":0 };

  META.members.forEach(m => {
    const v = RESP_MAP[`${m.member_id}|${dateStr}`] || "ãƒ¼";
    if (counts[v] === undefined) counts["ãƒ¼"]++;
    else counts[v]++;
  });

  return counts;
}


function refreshSummaryForDate_(dateStr){
  const idx = META.dates.findIndex(d => d.date === dateStr);
  if (idx < 0) return;

  // é›†è¨ˆè¡Œã¯ thead ã®2è¡Œç›®ï¼ˆ1è¡Œç›®=æ—¥æ™‚ã€2è¡Œç›®=é›†è¨ˆï¼‰
  const tr2 = document.querySelector("#shiftTable thead tr:nth-child(2)");
  if (!tr2) return;

  // å·¦3åˆ—ï¼ˆæ‹…å½“è€…/ãƒ­ãƒƒã‚¯/ã‚³ãƒ¡ãƒ³ãƒˆï¼‰ã®æ¬¡ãŒæ—¥ä»˜åˆ—
  const th = tr2.children[3 + idx];
  if (!th) return;

  const c = buildDaySummary_(dateStr);
  th.innerHTML = `
    <div class="summary-box">
      <span>ã€‡:${c["ã€‡"]}</span>
      <span>Ã—:${c["Ã—"]}</span>
      <span>â–³:${c["â–³"]}</span>
      <span>ï¼Ÿ:${c["ï¼Ÿ"]}</span>
      <span>ãƒ¼:${c["ãƒ¼"]}</span>
    </div>
  `;
}

function render() {
  const table = document.getElementById("shiftTable");
  table.innerHTML = "";

  const thead = document.createElement("thead");
  const tr1 = document.createElement("tr");

  const thName = document.createElement("th");
  thName.textContent = "æ‹…å½“è€…";
  thName.className = "sticky-left sticky-top";
  tr1.appendChild(thName);

  const thLock = document.createElement("th");
  thLock.textContent = "è¨˜å…¥ãƒ­ãƒƒã‚¯";
  thLock.className = "sticky-top lock-head";
  tr1.appendChild(thLock);

  const thComment = document.createElement("th");
  thComment.textContent = "ã‚³ãƒ¡ãƒ³ãƒˆ";
  thComment.className = "sticky-top  comment-head";
  tr1.appendChild(thComment);

  META.dates.forEach(d => {
    const th = document.createElement("th");
    th.className = "sticky-top";
    th.innerHTML = `
      <div class="date-head">
        ${d.date.slice(5).replace("-", "/")}<br>
        ${d.weekday}<br>
        ${d.time}<br>
        ${d.place}
      </div>`;
    tr1.appendChild(th);
  });

  thead.appendChild(tr1);

  // ===== é›†è¨ˆè¡Œï¼ˆãƒ˜ãƒƒãƒ€2æ®µç›®ï¼‰=====
  const tr2 = document.createElement("tr");

  // å·¦3åˆ—ï¼ˆæ‹…å½“è€…/ãƒ­ãƒƒã‚¯/ã‚³ãƒ¡ãƒ³ãƒˆï¼‰ã¯ç©ºã§OKï¼ˆã¾ãŸã¯ã€Œé›†è¨ˆã€ã¨æ›¸ãï¼‰
  const thS1 = document.createElement("th");
  thS1.className = "sticky-left summary-top";
  thS1.textContent = "";   // ã“ã“ã« "é›†è¨ˆ" ã¨æ›¸ã„ã¦ã‚‚OK
  tr2.appendChild(thS1);

  const thS2 = document.createElement("th");
  thS2.className = "summary-top";
  thS2.textContent = "";
  tr2.appendChild(thS2);

  const thS3 = document.createElement("th");
  thS3.className = "summary-top";
  thS3.textContent = "";
  tr2.appendChild(thS3);

  // æ—¥ä»˜åˆ—ã”ã¨ã®é›†è¨ˆ
  META.dates.forEach(d => {
    const th = document.createElement("th");
    th.className = "summary-top";

    const c = buildDaySummary_(d.date);

    th.innerHTML = `
      <div class="summary-box">
        <span>ã€‡:${c["ã€‡"]}</span>
        <span>Ã—:${c["Ã—"]}</span>
        <span>â–³:${c["â–³"]}</span>
        <span>ï¼Ÿ:${c["ï¼Ÿ"]}</span>
        <span>ãƒ¼:${c["ãƒ¼"]}</span>
      </div>
    `;
    tr2.appendChild(th);
  });

  thead.appendChild(tr2);


  table.appendChild(thead);

  const tbody = document.createElement("tbody");

  META.members.forEach(m => {
    const tr = document.createElement("tr");

    const tdName = document.createElement("td");
    tdName.textContent = m.member_name;
    tdName.className = "sticky-left";
    tr.appendChild(tdName);


////////
  const tdLock = document.createElement("td");
  tdLock.className = "lock-cell";

  const wrap = document.createElement("div");
  wrap.className = "lock-stack";

  const locked = !!m.locked; // â† members.locked ã‚’å‚ç…§

  // è¡Œã®ãƒ­ãƒƒã‚¯åæ˜ ï¼ˆãƒ­ãƒƒã‚¯ä¸­ã¯ã‚»ãƒ«ç·¨é›†ä¸å¯ï¼‰
  if (locked) tr.classList.add("is-locked");

  const btnLock = document.createElement("button");
  btnLock.type = "button";
  btnLock.className = "lock-btn";
  btnLock.textContent = "ãƒ­ãƒƒã‚¯";

  const btnUnlock = document.createElement("button");
  btnUnlock.type = "button";
  btnUnlock.className = "lock-btn";
  btnUnlock.textContent = "ãƒ­ãƒƒã‚¯è§£é™¤";

  // çŠ¶æ…‹ã«å¿œã˜ã¦æŠ¼ã›ã‚‹/æŠ¼ã›ãªã„ã‚’åˆ‡æ›¿ï¼ˆç”»åƒä»•æ§˜ï¼‰
  if (locked) {
    btnLock.classList.add("is-disabled");     // ãƒ­ãƒƒã‚¯ä¸­ã¯ã€Œãƒ­ãƒƒã‚¯ã€æŠ¼ã›ãªã„
  } else {
    btnUnlock.classList.add("is-disabled");   // è§£é™¤ä¸­ã¯ã€Œãƒ­ãƒƒã‚¯è§£é™¤ã€æŠ¼ã›ãªã„
  }

  async function setLocked(nextLocked) {
    // optimistic
    const prev = m.locked;
    m.locked = nextLocked;
    render();

    const url =
      `${API_URL}?action=setmemberlock` +
      `&month_key=${encodeURIComponent(META.month_key)}` + 
      `&member_id=${encodeURIComponent(m.member_id)}` +
      `&locked=${nextLocked}`;

    const res = await fetchJSON(url);
    if (!res.ok) {
      alert("ãƒ­ãƒƒã‚¯æ›´æ–°å¤±æ•—: " + (res.error || ""));
      // rollback
      m.locked = prev;
      render();
    }
  }

  btnLock.onclick = (e) => {
    e.preventDefault();
    e.stopPropagation();
    if (m.locked) return;
    setLocked(true);
  };

  btnUnlock.onclick = (e) => {
    e.preventDefault();
    e.stopPropagation();
    if (!m.locked) return;
    setLocked(false);
  };

  wrap.appendChild(btnLock);
  wrap.appendChild(btnUnlock);
  tdLock.appendChild(wrap);
  tr.appendChild(tdLock);

  const tdComment = document.createElement("td");
  tdComment.className = "comment-cell";

  const btnC = document.createElement("button");
  btnC.type = "button";
  btnC.className = "comment-btn";
  btnC.textContent =
   (COMMENT_MAP[m.member_id] && COMMENT_MAP[m.member_id].trim()) ? "ğŸ“" : "ï¼‹";

  btnC.onclick = (e) => {
    e.preventDefault();
    e.stopPropagation();
    openCommentModal_(m.member_id);
  };

  tdComment.appendChild(btnC);
  tr.appendChild(tdComment);

    META.dates.forEach(d => {
      const key = `${m.member_id}|${d.date}`;

const td = document.createElement("td");
td.className = "cell";

const box = document.createElement("div");
box.className = "cell-box";

const btns = document.createElement("div");
btns.className = "cell-btns";

["ã€‡", "Ã—", "â–³", "ï¼Ÿ"].forEach(v => {
  if (!META.choices.includes(v)) return;

  const b = document.createElement("button");
  b.className = "cell-btn";
  b.textContent = v;
  b.onclick = async (e) => {
  e.preventDefault();
    e.stopPropagation();

  if (m.locked) return;

    const curSpan = box.querySelector(".cell-cur");
    const old = curSpan.textContent;
    if (old === v) return;

    curSpan.textContent = v;
    td.classList.add("saving");

    const url =
      `${API_URL}?action=set` +
      `&month_key=${encodeURIComponent(META.month_key)}` +
      `&member_id=${encodeURIComponent(m.member_id)}` +
      `&date=${encodeURIComponent(d.date)}` +
      `&value=${encodeURIComponent(v)}`;

    const res = await fetchJSON(url);
    td.classList.remove("saving");

    if (!res.ok) {
      alert("ä¿å­˜å¤±æ•—: " + (res.error || ""));
      curSpan.textContent = old;
    } else {
      RESP_MAP[key] = v;
      refreshSummaryForDate_(d.date);
    }
  };

  btns.appendChild(b);
});

const cur = document.createElement("div");
cur.className = "cell-cur";
cur.textContent = RESP_MAP[key] || "ãƒ¼";

box.appendChild(btns);
box.appendChild(cur);
td.appendChild(box);




/*
  td.onclick = async () => {
    const old = td.textContent;
    const next = nextValue(old, META.choices);
    td.textContent = next;
    td.classList.add("saving");

    lastTouched[key] = Date.now();

    const url =
      `${API_URL}?action=set` +
      `&month_key=${encodeURIComponent(META.month_key)}` +
      `&member_id=${encodeURIComponent(m.member_id)}` +
      `&date=${encodeURIComponent(d.date)}` +
      `&value=${encodeURIComponent(next)}`;

let res;
try {
  res = await fetchJSON(url);
} catch (e) {
  alert("ã‚³ãƒ¡ãƒ³ãƒˆä¿å­˜å¤±æ•—ï¼ˆé€šä¿¡/JSONï¼‰: " + String(e));
  return;
}
if (!res || !res.ok) {
  alert("ã‚³ãƒ¡ãƒ³ãƒˆä¿å­˜å¤±æ•—: " + (res?.error || ""));
  return;
}

    td.classList.remove("saving");
    if (!res.ok) {
      alert("ä¿å­˜å¤±æ•—: " + (res.error || ""));
      td.textContent = old;
    } else {
      RESP_MAP[key] = next;
    }
  };
*/

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  requestAnimationFrame(() => {
    setStickyTop_();       // ãƒ˜ãƒƒãƒ€ï¼ˆé’ãƒãƒ¼ï¼‰é«˜ã•ã‚’CSSå¤‰æ•°ã¸
    adjustSummaryTop_();   // 1æ®µç›®ãƒ˜ãƒƒãƒ€é«˜ã•ã«åˆã‚ã›ã¦é›†è¨ˆè¡Œã‚’ãšã‚‰ã™
  });

}


function setStickyTop_() {
  const h = document.querySelector("header")?.offsetHeight || 52;
  document.documentElement.style.setProperty("--header-h", `${h}px`);
}

function adjustSummaryTop_(){
  // 1æ®µç›®ãƒ˜ãƒƒãƒ€ã®é«˜ã•ï¼ˆæ—¥æ™‚/å ´æ‰€è¡Œï¼‰
  const firstHead = document.querySelector("#shiftTable thead tr:first-child th");
  const h1 = firstHead ? firstHead.offsetHeight : 48;

  // é›†è¨ˆè¡Œï¼ˆsummary-topï¼‰ã® sticky top ã‚’åˆã‚ã›ã‚‹
  document.querySelectorAll("th.summary-top").forEach(th => {
    th.style.top = `${h1}px`;
  });
}

let loading = false;

function bindCommentModalButtons_() {
  const btnSave = document.getElementById("commentSave");
  const btnCancel = document.getElementById("commentCancel");
  const modal = document.getElementById("commentModal");

  if (btnSave) btnSave.onclick = saveComment_;
  if (btnCancel) btnCancel.onclick = closeCommentModal_;

  // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  if (modal) {
    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeCommentModal_();
    });
  }

  // Escã§é–‰ã˜ã‚‹ï¼ˆPCï¼‰
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeCommentModal_();
  });

}



// ===== è¡Œï¼‹åˆ—ãƒ›ãƒãƒ¼å¼·èª¿ï¼ˆ1å›ã ã‘ç™»éŒ²ï¼‰=====
function setupHoverHighlight_() {
  const table = document.getElementById("shiftTable");
  if (!table || table.dataset.hoverBound === "1") return;
  table.dataset.hoverBound = "1";

  table.addEventListener("mouseover", (e) => {
    const td = e.target.closest("td");
    if (!td) return;

    const tr = td.parentElement;
    const index = td.cellIndex;

    tr.classList.add("is-hover-row");

    document
      .querySelectorAll(`#shiftTable tbody tr td:nth-child(${index + 1})`)
      .forEach(cell => cell.classList.add("is-hover-col"));
  });

  table.addEventListener("mouseout", () => {
    document.querySelectorAll(".is-hover-row")
      .forEach(el => el.classList.remove("is-hover-row"));
    document.querySelectorAll(".is-hover-col")
      .forEach(el => el.classList.remove("is-hover-col"));
  });
}


async function loadAll() {
  // å¤šé‡èµ·å‹•é˜²æ­¢ï¼ˆå‰å›ã® loadAll ãŒçµ‚ã‚ã‚‹å‰ã«æ¬¡ãŒèµ°ã‚‹ã®ã‚’é˜²ãï¼‰
  if (loading) return;
  loading = true;

  try {
    setStickyTop_();

    // meta + responses ã‚’1å›ã§å–å¾—ï¼ˆGASå´ã§ action=all ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹å‰æï¼‰
    const all = await fetchJSON(`${API_URL}?action=all&month=${month}`);

    // all.ok ã®ç¢ºèªï¼ˆGASã®jsonOut_ä»•æ§˜ã«åˆã‚ã›ã‚‹ï¼‰
    if (!all || all.ok === false) {
      alert("èª­ã¿è¾¼ã¿å¤±æ•—: " + (all?.error || "unknown error"));
      return;
    }

    META = all.meta;

    // comments ã‚’åæ˜ ï¼ˆmember_id -> commentï¼‰
    COMMENT_MAP = {};
    (all.comments || []).forEach(c => {
      COMMENT_MAP[c.member_id] = c.comment || "";
    });

    // ç”»é¢è¡¨ç¤ºï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ»æœŸé™ï¼‰
    document.getElementById("title").textContent = META.title || "";
    document.getElementById("deadline").textContent = "å…¥åŠ›æœŸé™: " + (META.deadline || "");

    // responses ã‚’åæ˜ ã—ã¦æç”»
    RESP_MAP = buildRespMap(all.responses || []);
    render();

    setupHoverHighlight_();

  } catch (err) {
    alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + String(err));
  } finally {
    loading = false;

    // è‡ªå‹•å†èª­è¾¼ï¼ˆmeta ãŒå–ã‚ŒãŸå ´åˆã®ã¿ï¼‰
    if (META && Number(META.ui_refresh_sec) > 0) {
      setTimeout(loadAll, Number(META.ui_refresh_sec) * 1000);
    }
  }
}

bindCommentModalButtons_();
loadAll();
</script>

</body>
</html>
